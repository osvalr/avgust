/*
* Copyright «©» ${anho}, J.R Totem. All rights reserved.
*
* This file was generated by MybatisModelGenerator v.3.0.
* All changes made in this file will be lost if you recompile the source schema.
*
* [GeneratorCrud v.1.0] by JRaffo 
*/

/**
* @author  Javier Raffo
* @version 1.0
* @since   ${datetimeCreate}
*/

package ${packageServiceImpl};

import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import pe.com.acme.util.DtoUtil;
import pe.com.acme.util.MybatisRepositoryHelper;

import ${packageService}.${nameService}Service;
import ${classModel};
import ${classModel}Criteria;
import ${classMapperModel};

#foreach( $e in $entity )
import ${e.classEntity};
import ${e.classMapperEntity};
#foreach( $se in $e.subBeans )
import ${se.classEntity};
import ${se.classMapperEntity};
#end
#end

#foreach( $e in $subModels )
import ${e.classModel};
import ${e.classEntity};
import ${e.classMapperEntity};
#end

@Service
public class ${nameServiceImpl}ServiceImpl extends MybatisRepositoryHelper implements ${nameService}Service {

	@Autowired
	private DtoUtil dtoUtil;
	
	@Transactional(rollbackForClassName = {"Exception"})
	@Override
	public Integer create(${nameModel} model) throws Exception {
		
		Integer lastId = null;
#foreach( $e in $entity )

		${e.nameEntity} ${e.nameVarEntity} = dtoUtil.copyBean(model, ${e.nameEntity}.class);
		this.insertSelective(${e.nameMapperEntity}.class, ${e.nameVarEntity});
#set($nameVarEntityMain = ${e.nameVarEntity})
#set($primaryKeyGetMethodMain = ${e.primaryKeyGetMethod})
#foreach( $se in $e.subBeans )

		${se.nameEntity} ${se.nameVarEntity} = dtoUtil.copyBean(model, ${se.nameEntity}.class);
#if(!$se.joinPropertySetMethod)
		${se.nameVarEntity}.${se.primaryKeySetMethod}($nameVarEntityMain.$primaryKeyGetMethodMain());${se.otherProperties}
#else
		${se.nameVarEntity}.${se.joinPropertySetMethod}($nameVarEntityMain.${se.joinPropertyGetMethod}());${se.otherProperties}
#end
		this.insertSelective(${se.nameMapperEntity}.class, ${se.nameVarEntity});
#set($nameVarEntityMain = ${se.nameVarEntity})
#set($primaryKeyGetMethodMain = ${se.primaryKeyGetMethod})
#end
#end
		
#foreach( $e in $subModels )
        this.insertNewRecords${e.nameModel}(model.getList${e.nameModel}(), ${e.nameVarModelProperty}.${e.joinPropertyGetMethod}());
#end
		lastId = ${returnProperty}
		return lastId;

	}
	
	@Transactional(rollbackForClassName = {"Exception"})
	@Override
	public void update(${nameModel} model) throws Exception {
	
#foreach( $e in $entity )
		${e.nameEntity} ${e.nameVarEntity} = dtoUtil.copyBean(model, ${e.nameEntity}.class);
		this.updateByPrimaryKeySelective(${e.nameMapperEntity}.class, ${e.nameVarEntity});
		
#foreach( $se in $e.subBeans )
		${se.nameEntity} ${se.nameVarEntity} = dtoUtil.copyBean(model, ${se.nameEntity}.class);
		this.updateByPrimaryKeySelective(${se.nameMapperEntity}.class, ${se.nameVarEntity});
		
#end
#end
#foreach( $e in $subModels )
        this.insertNewRecords${e.nameModel}(model.getList${e.nameModel}(), ${e.nameVarModelProperty}.${e.joinPropertyGetMethod}());
        this.updateModifiedRecords${e.nameModel}(model.getList${e.nameModel}());
        this.removeRecords${e.nameModel}(model.getList${e.nameModel}(), true);
#end
		
	}

	@Transactional(rollbackForClassName = {"Exception"})
	@Override
	public void destroy(${nameModel} model) throws Exception {
	
#foreach( $e in $subModels )
        this.removeRecords${e.nameModel}(model.getList${e.nameModel}(), false);
#end
#foreach( $e in $entityDelete )

		${e.nameEntity} ${e.nameVarEntity} = dtoUtil.copyBean(model, ${e.nameEntity}.class);
		this.deleteByPrimaryKey(${e.nameMapperEntity}.class, ${e.nameVarEntity});
#end
	}

	@Override
	public List<${nameModel}> list(${nameModel}Criteria criteria) throws Exception {
		List<${nameModel}> list = this.selectByQuery(${nameModel}Mapper.class, criteria);
		return list;
	}

	@Transactional(rollbackForClassName = {"Exception"})
	@Override
	public int countRecords(${nameModel}Criteria criteria) throws Exception {
		int count = this.selectCountByQuery(${nameModel}Mapper.class, criteria);
		return count;
	}

#foreach( $e in $subModels )
    @Transactional(rollbackForClassName = {"Exception"})
    private void insertNewRecords${e.nameModel}(List<${e.nameModel}> list${e.nameModel}, Integer id) throws Exception{

        for(${e.nameModel} ${e.nameVarModel} : list${e.nameModel}){

            if(${e.nameVarModel}.isNewEntry()){
                ${e.nameVarModel}.${e.joinPropertySetMethod}(id);
                ${e.nameEntity} ${e.nameVarEntity} = dtoUtil.copyBean(${e.nameVarModel}, ${e.nameEntity}.class);                
                this.insertSelective(${e.nameMapperEntity}.class, ${e.nameVarEntity});
            }

        }

    }

    @Transactional(rollbackForClassName = {"Exception"})
    private void updateModifiedRecords${e.nameModel}(List<${e.nameModel}> list${e.nameModel}) throws Exception{

        for(${e.nameModel} ${e.nameVarModel} : list${e.nameModel}){

            if(${e.nameVarModel}.isUpdatedRecord()){
            	${e.nameEntity} ${e.nameVarEntity} = dtoUtil.copyBean(${e.nameVarModel}, ${e.nameEntity}.class);
            	this.updateByPrimaryKeySelective(${e.nameMapperEntity}.class, ${e.nameVarEntity});
            }

        }

    }

    @Transactional(rollbackForClassName = {"Exception"})
    private void removeRecords${e.nameModel}(List<${e.nameModel}> list${e.nameModel}, boolean onlyFlag) throws Exception{

    	for(${e.nameModel} ${e.nameVarModel} : list${e.nameModel}){

            if(onlyFlag){
                if(${e.nameVarModel}.isRemovedRecord()){
                    ${e.nameEntity} ${e.nameVarEntity} = dtoUtil.copyBean(${e.nameVarModel}, ${e.nameEntity}.class);
                    this.deleteByPrimaryKey(${e.nameMapperEntity}.class, ${e.nameVarEntity});
                }
            }else{
            	${e.nameEntity} ${e.nameVarEntity} = dtoUtil.copyBean(${e.nameVarModel}, ${e.nameEntity}.class);
                this.deleteByPrimaryKey(${e.nameMapperEntity}.class, ${e.nameVarEntity});
            }

        }

    }	
#end
}
